---
import Layout from "../../layouts/Layout.astro";
import TableOfContents from "../../components/TableOfContent.astro";
import postsData from "../../content/blog/post.json";

export async function getStaticPaths() {
  return postsData.map((post) => ({
    params: { slug: post.slug },
    props: { post, slug: post.slug },
  }));
}

const { slug } = Astro.props;

import postsJson from '../../content/blog/blog.json';

const postsArray = Array.isArray(postsJson) ? postsJson : [postsJson];
const detailPost = postsArray.find((post) => post.slug === slug);
const date = detailPost ? new Date(detailPost.publishedAt) : null;

function extractHeadings(nodes: any[]): { depth: number; text: string; slug: string }[] {
  const headings: { depth: number; text: string; slug: string }[] = [];
  for (const node of nodes) {
    if (node.type === "heading") {
      const text = node.children.map((c) => c.text).join("");
      const slug = text
        .toLowerCase()
        .replace(/[^\w]+/g, "-")
        .replace(/(^-|-$)/g, "");
      headings.push({ depth: node.level || 2, text, slug });
    }
    if (node.children) {
      headings.push(...extractHeadings(node.children));
    }
  }
  return headings;
}

const headings = detailPost ? extractHeadings(detailPost.content.root.children) : [];
---

<Layout title={detailPost.title}>
    <main class="app-container pt-36 flex flex-col lg:flex-row gap-10">
        <div class="flex-1">
            {detailPost.heroImage?.url && (
                <img src={detailPost.heroImage.url} alt={detailPost.title} class="rounded-lg mb-6" />
            )}

            <h1 class="text-4xl font-bold mb-2">{detailPost.title}</h1>
            <p class="text-sm text-gray-500 mb-8">
                Publicado el {new Date(detailPost.publishedAt).toLocaleDateString("es-CL")}
            </p>

            <article class="prose prose-lg dark:prose-invert">
                {detailPost.content?.root?.children.map((node, index) => {
                    if (node.type === "heading") {
                        const text = node.children.map((c) => c.text).join("");
                        const slug = text
                        .toLowerCase()
                        .replace(/[^\w]+/g, "-")
                        .replace(/(^-|-$)/g, "");
                        const Tag = node.tag || `h${node.level || 2}`;
                        return <Tag id={slug} class="font-bold text-xl">{text}</Tag>;
                    }
                    if (node.type === "paragraph") {
                        return <p>{node.children.map((c) => c.text).join("")}</p>;
                    }
                return null;
                })}
            </article>
        </div>
        {headings.length > 0 && (
        <aside class="hidden lg:block w-64 self-start">
            <TableOfContents headings={headings} />
        </aside>
        )}
    </main>
</Layout>
